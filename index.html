<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Daily Workout Routine</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .date {
        font-size: 1.2rem;
        opacity: 0.9;
      }

      .controls {
        padding: 20px 30px;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 14px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .loading {
        display: none;
        color: #666;
        font-style: italic;
      }

      .exercises-grid {
        padding: 30px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
      }

      .exercise-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
        position: relative;
      }

      .exercise-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
      }

      .exercise-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
      }

      .exercise-name {
        font-size: 1.3rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .exercise-type {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .exercise-target {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 15px;
        font-style: italic;
      }

      .exercise-reps {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-weight: 600;
        color: #495057;
      }

      .exercise-description {
        color: #666;
        line-height: 1.5;
        margin-bottom: 20px;
      }

      .complete-btn {
        background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        width: 100%;
        transition: all 0.3s ease;
      }

      .complete-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 5px 15px rgba(81, 207, 102, 0.3);
      }

      .complete-btn.completed {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      }

      .complete-btn.completed::before {
        content: "‚úì ";
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        margin: 20px 30px;
        border-radius: 8px;
        border: 1px solid #f5c6cb;
      }

      .empty-state {
        text-align: center;
        padding: 60px 30px;
        color: #666;
      }

      .empty-state h3 {
        margin-bottom: 15px;
        color: #495057;
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 2rem;
        }

        .controls {
          flex-direction: column;
          align-items: stretch;
        }

        .exercises-grid {
          grid-template-columns: 1fr;
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üí™ Daily Workout Routine</h1>
        <div class="date" id="currentDate"></div>
      </div>

      <div class="controls">
        <button class="btn" id="generateBtn">üéØ Generate New Routine</button>
        <button class="btn" id="loadTodayBtn">üìÖ Load Today's Routine</button>
        <button class="btn" id="clearBtn">üóëÔ∏è Clear Routine</button>
        <div class="loading" id="loading">Generating your workout...</div>
      </div>

      <div id="error" class="error" style="display: none"></div>

      <div id="exercisesContainer" class="exercises-grid">
        <div class="empty-state">
          <h3>Ready to get moving?</h3>
          <p>Click "Generate New Routine" to get your 4 exercises for today!</p>
        </div>
      </div>
    </div>

    <script type="module">
      // Configuration - Replace with your actual values
      const SUPABASE_URL = "https://fpsvqaxiflesnxkvjjvp.supabase.co";
      const SUPABASE_ANON_KEY =
        "sb_publishable_vCfgQhch2X3xXS8ZbecrAg_rHzpIfwG";
      const GEMINI_API_KEY = "AIzaSyAG_-hqMi-ULhPVtT6UBX0meIxzvdzmmtc";

      // Initialize Supabase
      const { createClient } = supabase;
      const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // DOM Elements
      const generateBtn = document.getElementById("generateBtn");
      const loadTodayBtn = document.getElementById("loadTodayBtn");
      const clearBtn = document.getElementById("clearBtn");
      const loading = document.getElementById("loading");
      const exercisesContainer = document.getElementById("exercisesContainer");
      const errorDiv = document.getElementById("error");
      const currentDateEl = document.getElementById("currentDate");

      // Set current date
      currentDateEl.textContent = new Date().toLocaleDateString("en-US", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
      });

      // Get recent exercises to avoid repetition
      async function getRecentExercises() {
        try {
          const pastWeek = new Date();
          pastWeek.setDate(pastWeek.getDate() - 7);
          const pastWeekStr = pastWeek.toISOString().split('T')[0];
          
          const { data, error } = await supabaseClient
            .from('workout_routines')
            .select('exercises')
            .gte('date', pastWeekStr)
            .order('date', { ascending: false });

          if (error) throw error;
          
          const recentExercises = [];
          data?.forEach(routine => {
            routine.exercises?.forEach(exercise => {
              recentExercises.push(exercise.name);
            });
          });
          
          return [...new Set(recentExercises)]; // Remove duplicates
        } catch (error) {
          console.error('Error getting recent exercises:', error);
          return [];
        }
      }

      // Enhanced Gemini AI function with exercise history
      async function generateWorkoutWithGemini() {
        // Get recent exercises to avoid repetition
        const recentExercises = await getRecentExercises();
        
        // Add randomness and variety to the prompt
        const currentTime = new Date().getTime();
        const randomSeed = Math.floor(Math.random() * 1000);
        const today = new Date().toLocaleDateString();
        
        const exerciseVariations = [
          "Include creative variations and avoid common exercises like basic push-ups and squats",
          "Focus on functional movements and compound exercises",
          "Mix traditional exercises with modern fitness trends",
          "Include both dynamic and static holds",
          "Emphasize different movement patterns and planes of motion"
        ];
        
        const intensityLevels = [
          "beginner-friendly with modifications",
          "intermediate difficulty",
          "challenging but doable at home",
          "mix of easy and hard exercises"
        ];
        
        const randomVariation = exerciseVariations[Math.floor(Math.random() * exerciseVariations.length)];
        const randomIntensity = intensityLevels[Math.floor(Math.random() * intensityLevels.length)];
        
        let avoidanceText = "";
        if (recentExercises.length > 0) {
          avoidanceText = `\n\nIMPORTANT: AVOID these recently used exercises: ${recentExercises.join(', ')}
          Generate completely different exercises that are NOT in this list.`;
        }
        
        const prompt = `Generate exactly 4 UNIQUE and DIFFERENT exercises for today's workout (${today}). 
  
        
        Guidelines:
        - ${randomVariation}
        - Make them ${randomIntensity}
        - No equipment needed (bodyweight only)
        - Avoid repetitive or basic exercises
        - Each exercise should target different muscle groups
        - Be creative and include exercise variations
        ${avoidanceText}
        
        Random seed: ${randomSeed} (use this for variation)
            
        Respond ONLY with a valid JSON array in this exact format:
        [
            {
                "name": "Exercise Name",
                "type": "Exercise Type (Bodyweight/Cardio/Strength/Core)",
                "target": "Target muscles",
                "reps": "Sets and reps (e.g., '3 sets of 12' or '30 seconds')",
                "description": "Brief description of proper form"
            }
        ]`;

        try {
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemma-3n-e4b-it:generateContent?key=${GEMINI_API_KEY}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: prompt,
                      },
                    ],
                  },
                ],
              }),
            }
          );

          if (!response.ok) {
            throw new Error(`Gemini API error: ${response.status}`);
          }

          const data = await response.json();
          const generatedText = data.candidates[0].content.parts[0].text;

          // Clean up the response and parse JSON
          const jsonMatch = generatedText.match(/\[[\s\S]*\]/);
          if (!jsonMatch) {
            throw new Error("Could not extract JSON from Gemini response");
          }

          return JSON.parse(jsonMatch[0]);
        } catch (error) {
          console.error("Gemini API Error:", error);
          throw error;
        }
      }

      // Save routine to Supabase
      async function saveRoutineToSupabase(exercises) {
        const today = new Date().toISOString().split("T")[0];

        try {
          const { data, error } = await supabaseClient
            .from("workout_routines")
            .upsert(
              {
                date: today,
                exercises: exercises,
              },
              {
                onConflict: "date",
              }
            );

          if (error) throw error;
          return data;
        } catch (error) {
          console.error("Supabase Error:", error);
          throw error;
        }
      }

      // Load routine from Supabase
      async function loadRoutineFromSupabase(date = null) {
        const targetDate = date || new Date().toISOString().split("T")[0];

        try {
          const { data, error } = await supabaseClient
            .from("workout_routines")
            .select("exercises")
            .eq("date", targetDate)
            .single();

          if (error && error.code !== "PGRST116") throw error;
          return data?.exercises || null;
        } catch (error) {
          console.error("Supabase Error:", error);
          throw error;
        }
      }

      // Display exercises
      function displayExercises(exercises) {
        if (!exercises || exercises.length === 0) {
          exercisesContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>No routine found for today</h3>
                        <p>Generate a new routine to get started!</p>
                    </div>
                `;
          return;
        }

        exercisesContainer.innerHTML = exercises
          .map(
            (exercise, index) => `
                <div class="exercise-card">
                    <div class="exercise-header">
                        <div>
                            <div class="exercise-name">${exercise.name}</div>
                            <div class="exercise-target">${exercise.target}</div>
                        </div>
                        <div class="exercise-type">${exercise.type}</div>
                    </div>
                    <div class="exercise-reps">${exercise.reps}</div>
                    <div class="exercise-description">${exercise.description}</div>
                    <button class="complete-btn" onclick="toggleComplete(${index})">
                        Mark as Complete
                    </button>
                </div>
            `
          )
          .join("");
      }

      // Toggle exercise completion
      window.toggleComplete = function (index) {
        const btn = document.querySelectorAll(".complete-btn")[index];
        if (btn.classList.contains("completed")) {
          btn.classList.remove("completed");
          btn.textContent = "Mark as Complete";
        } else {
          btn.classList.add("completed");
          btn.textContent = "Completed";
        }
      };

      // Show error
      function showError(message) {
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        setTimeout(() => {
          errorDiv.style.display = "none";
        }, 5000);
      }

      // Show loading
      function setLoading(isLoading) {
        loading.style.display = isLoading ? "block" : "none";
        generateBtn.disabled = isLoading;
        loadTodayBtn.disabled = isLoading;
      }

      // Event Listeners
      generateBtn.addEventListener("click", async () => {
        setLoading(true);
        try {
          const exercises = await generateWorkoutWithGemini();
          await saveRoutineToSupabase(exercises);
          displayExercises(exercises);
        } catch (error) {
          showError(
            "Failed to generate workout. Please check your API keys and try again."
          );
          console.error(error);
        } finally {
          setLoading(false);
        }
      });

      loadTodayBtn.addEventListener("click", async () => {
        setLoading(true);
        try {
          const exercises = await loadRoutineFromSupabase();
          if (exercises) {
            displayExercises(exercises);
          } else {
            showError("No routine found for today. Generate a new one!");
          }
        } catch (error) {
          showError("Failed to load routine from database.");
          console.error(error);
        } finally {
          setLoading(false);
        }
      });

      clearBtn.addEventListener("click", () => {
        exercisesContainer.innerHTML = `
                <div class="empty-state">
                    <h3>Ready to get moving?</h3>
                    <p>Click "Generate New Routine" to get your 4 exercises for today!</p>
                </div>
            `;
      });

      // Load today's routine on page load
      window.addEventListener("load", async () => {
        try {
          const exercises = await loadRoutineFromSupabase();
          if (exercises) {
            displayExercises(exercises);
          }
        } catch (error) {
          console.error("Failed to load routine on startup:", error);
        }
      });
    </script>
  </body>
</html>
